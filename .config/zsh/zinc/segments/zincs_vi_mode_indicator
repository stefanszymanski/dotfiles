# vim: ft=zsh ts=2 sw=2 et fenc=utf-8

function vi-mode-change () {
	VI_MODE_INDICATOR_DISPLAY=true
  zle prompt_zinc_redraw_soft
}

function _zincs_vi_mode_indicator_hide () {
	VI_MODE_INDICATOR_DISPLAY=false
  zle prompt_zinc_redraw_soft
}

function _zincs_vi_mode_indicator_show () {
	VI_MODE_INDICATOR_DISPLAY=true
  zle prompt_zinc_redraw_soft
}

function zincs_vi_mode_indicator () {
	local prompt

	case $VIM_MODE_KEYMAP in 
		vicmd)        prompt=NORMAL ;;
		replace)      prompt=REPLACE ;;
		isearch)      prompt=SEARCH ;;
		visual)       prompt=VISUAL ;;
		vline)       	prompt=V-LINE ;;
		main|viins|*) prompt=INSERT ;;
	esac

  REPLY="$prompt"
}

# Update the sgement when the vi mode changes.
zle -N vi-mode-change
# Hide the segment when the line finishs.
add-zle-hook-widget line-finish _zincs_vi_mode_indicator_hide
# Show the segment when a line is started.
add-zle-hook-widget line-init _zincs_vi_mode_indicator_show

# Hide the indicator on SIGINT, e.g. when ctrl+c was pressed.
TRAPINT() {
	VIM_MODE_KEYMAP=viins
	_zincs_vi_mode_indicator_hide
	return $1
}

zincs_vi_mode_indicator "$@"
